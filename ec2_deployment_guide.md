# EC2 Deployment Guide

This guide provides step-by-step instructions for deploying the Django application to an AWS EC2 instance.

## Prerequisites

Before you begin, make sure you have:

1. An AWS account with access to EC2 and RDS services
2. Your application code in a Git repository (GitHub, GitLab, etc.)
3. A domain name (optional, but recommended for production)

## Step 1: Launch an EC2 Instance

1. Log in to the AWS Management Console and navigate to the EC2 dashboard
2. Click "Launch Instance"
3. Choose an Amazon Machine Image (AMI)
   - Recommended: Ubuntu Server 22.04 LTS
4. Choose an Instance Type
   - For testing: t2.micro (eligible for free tier)
   - For production: t2.small or larger depending on your needs
5. Configure Instance Details
   - Use default settings or customize as needed
6. Add Storage
   - Default 8GB is sufficient for most Django applications
7. Add Tags (optional)
   - Name: your-app-name
8. Configure Security Group
   - Create a new security group with the following rules:
     - SSH (port 22): Your IP address
     - HTTP (port 80): Anywhere (0.0.0.0/0)
     - HTTPS (port 443): Anywhere (0.0.0.0/0)
9. Review and Launch
10. Create or select an existing key pair
    - Download the key pair (.pem file) and keep it secure
11. Launch the instance

## Step 2: Set Up a PostgreSQL Database

You have two options for setting up a PostgreSQL database:

### Option 1: Use Amazon RDS (Recommended for Production)

1. Navigate to the RDS dashboard in the AWS Management Console
2. Click "Create database"
3. Choose "Standard create" and select PostgreSQL
4. Choose a DB instance size (db.t3.micro for testing)
5. Set up credentials (username and password)
6. Configure network settings to allow access from your EC2 instance
   - Use the same VPC as your EC2 instance
   - Create or use an existing security group that allows inbound traffic on port 5432 from your EC2 instance
7. Create the database

### Option 2: Install PostgreSQL on the EC2 Instance (For Development/Testing)

This option is covered in the deployment script, but you'll need to create the database and user manually.

## Step 3: Connect to Your EC2 Instance

1. Open a terminal on your local machine
2. Change permissions on your key pair file:
   ```
   chmod 400 your-key-pair.pem
   ```
3. Connect to your instance:
   ```
   ssh -i your-key-pair.pem ubuntu@your-ec2-public-dns
   ```

## Step 4: Prepare the Deployment Script

1. Upload the `ec2_deploy.sh` script to your EC2 instance:
   ```
   scp -i your-key-pair.pem ec2_deploy.sh ubuntu@your-ec2-public-dns:~
   ```

2. Edit the script to update the following variables:
   - Replace `https://github.com/yourusername/your-repo.git` with your actual Git repository URL
   - Replace `your-domain.com` with your actual domain name
   - Update database credentials with your actual RDS or local PostgreSQL credentials

## Step 5: Run the Deployment Script

1. Make the script executable:
   ```
   chmod +x ec2_deploy.sh
   ```

2. Run the script:
   ```
   ./ec2_deploy.sh
   ```

3. The script will:
   - Update system packages
   - Install required dependencies
   - Clone your repository
   - Set up a Python virtual environment
   - Install Python dependencies
   - Configure environment variables
   - Collect static files
   - Set up Gunicorn as a service
   - Configure Nginx

## Step 6: Update Environment Variables

After the script completes, you should update the environment variables in the `.env` file with your actual values:

```
nano /home/ubuntu/aws-app/.env
```

Update the following variables:
- `DJANGO_SECRET_KEY`: A secure random string (already generated by the script)
- `ALLOWED_HOSTS`: Add your domain name and EC2 public DNS
- `DB_NAME`: Your database name
- `DB_USER`: Your database username
- `DB_PASSWORD`: Your database password
- `DB_HOST`: Your RDS endpoint or localhost
- `DB_PORT`: Usually 5432 for PostgreSQL

Save the file and restart Gunicorn:

```
sudo systemctl restart gunicorn
```

## Step 7: Set Up Domain Name (Optional)

If you have a domain name:

1. Update your domain's DNS settings to point to your EC2 instance's public IP address
2. Update the Nginx configuration:
   ```
   sudo nano /etc/nginx/sites-available/aws
   ```
3. Replace `your-domain.com` with your actual domain name
4. Save and restart Nginx:
   ```
   sudo systemctl restart nginx
   ```

## Step 8: Set Up HTTPS with Let's Encrypt (Recommended for Production)

1. Install Certbot:
   ```
   sudo apt-get update
   sudo apt-get install certbot python3-certbot-nginx
   ```

2. Obtain and install a certificate:
   ```
   sudo certbot --nginx -d your-domain.com
   ```

3. Follow the prompts to complete the setup

## Troubleshooting

### Check Gunicorn Status

```
sudo systemctl status gunicorn
```

### Check Nginx Status

```
sudo systemctl status nginx
```

### View Gunicorn Logs

```
sudo journalctl -u gunicorn
```

### View Nginx Logs

```
sudo tail -f /var/log/nginx/error.log
```

## Updating the Application

To update your application:

1. SSH into your EC2 instance
2. Navigate to your application directory:
   ```
   cd /home/ubuntu/aws-app
   ```
3. Pull the latest changes:
   ```
   git pull
   ```
4. Activate the virtual environment:
   ```
   source venv/bin/activate
   ```
5. Install any new dependencies:
   ```
   pip install -r requirements.txt
   ```
6. Collect static files if needed:
   ```
   python manage.py collectstatic --noinput --settings=aws.settings.prod
   ```
7. Restart Gunicorn:
   ```
   sudo systemctl restart gunicorn
   ```

## Security Considerations

1. Restrict SSH access to your IP address only
2. Use strong passwords for your database
3. Keep your system and packages updated
4. Consider using AWS Security Groups to restrict access
5. Set up HTTPS with Let's Encrypt
6. Remove any sensitive information from your code repository